<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Финансовый калькулятор с приоритетами</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="student-info">
            <h1><i class="fas fa-calculator"></i> Финансовый калькулятор</h1>
            <div class="info-card">
                <p><i class="fas fa-user-graduate"></i> <strong>Студент:</strong> Штомпель Дарья Романовна</p>
                <p><i class="fas fa-book"></i> <strong>Курс:</strong> 4</p>
                <p><i class="fas fa-users"></i> <strong>Группа:</strong> 4</p>
                <p><i class="fas fa-calendar"></i> <strong>Год:</strong> 2025</p>
            </div>
        </header>

        <div class="priority-info">
            <div class="priority-card">
                <i class="fas fa-info-circle"></i>
                <strong>Приоритет операций:</strong> (Число2 операция Число3) → Число1 операция (результат) → результат операция Число4
            </div>
        </div>

        <main class="calculator">
            <div class="input-section">
                <div class="expression-row">
                    <div class="operand-block">
                        <div class="operand-label">Число 1</div>
                        <div class="input-wrapper">
                            <input type="text" id="num1" value="0" placeholder="Введите число...">
                            <button class="icon-btn small" onclick="copyToClipboard('num1')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="normalized">Норм: <span id="norm1">0</span></div>
                    </div>

                    <div class="operation-block">
                        <select class="operation-select" id="op1">
                            <option value="add">+</option>
                            <option value="subtract">-</option>
                            <option value="multiply">×</option>
                            <option value="divide">÷</option>
                        </select>
                        <div class="op-label">Операция 1</div>
                    </div>

                    <div class="parenthesis-block">
                        <div class="parenthesis">(</div>
                    </div>

                    <div class="operand-block">
                        <div class="operand-label">Число 2</div>
                        <div class="input-wrapper">
                            <input type="text" id="num2" value="0" placeholder="Введите число...">
                            <button class="icon-btn small" onclick="copyToClipboard('num2')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="normalized">Норм: <span id="norm2">0</span></div>
                    </div>

                    <div class="operation-block">
                        <select class="operation-select" id="op2">
                            <option value="add">+</option>
                            <option value="subtract">-</option>
                            <option value="multiply">×</option>
                            <option value="divide">÷</option>
                        </select>
                        <div class="op-label">Операция 2</div>
                    </div>

                    <div class="operand-block">
                        <div class="operand-label">Число 3</div>
                        <div class="input-wrapper">
                            <input type="text" id="num3" value="0" placeholder="Введите число...">
                            <button class="icon-btn small" onclick="copyToClipboard('num3')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="normalized">Норм: <span id="norm3">0</span></div>
                    </div>

                    <div class="parenthesis-block">
                        <div class="parenthesis">)</div>
                    </div>

                    <div class="operation-block">
                        <select class="operation-select" id="op3">
                            <option value="add">+</option>
                            <option value="subtract">-</option>
                            <option value="multiply">×</option>
                            <option value="divide">÷</option>
                        </select>
                        <div class="op-label">Операция 3</div>
                    </div>

                    <div class="operand-block">
                        <div class="operand-label">Число 4</div>
                        <div class="input-wrapper">
                            <input type="text" id="num4" value="0" placeholder="Введите число...">
                            <button class="icon-btn small" onclick="copyToClipboard('num4')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="normalized">Норм: <span id="norm4">0</span></div>
                    </div>
                </div>
            </div>

            <div class="rounding-section">
                <h3><i class="fas fa-ruler-combined"></i> Метод округления результата:</h3>
                <div class="rounding-options">
                    <label class="rounding-option">
                        <input type="radio" name="rounding" value="mathematical" checked>
                        <span class="rounding-label">
                            <i class="fas fa-calculator"></i>
                            <span class="rounding-text">Математическое</span>
                            <span class="rounding-desc">Обычное округление</span>
                        </span>
                    </label>
                    
                    <label class="rounding-option">
                        <input type="radio" name="rounding" value="bankers">
                        <span class="rounding-label">
                            <i class="fas fa-university"></i>
                            <span class="rounding-text">Бухгалтерское</span>
                            <span class="rounding-desc">Банковское округление</span>
                        </span>
                    </label>
                    
                    <label class="rounding-option">
                        <input type="radio" name="rounding" value="truncate">
                        <span class="rounding-label">
                            <i class="fas fa-cut"></i>
                            <span class="rounding-text">Усечение</span>
                            <span class="rounding-desc">Отбрасывание дробной части</span>
                        </span>
                    </label>
                </div>
            </div>

            <div class="result-section">
                <button id="calculate-btn" class="calculate-btn">
                    <i class="fas fa-equals"></i> Вычислить результат
                </button>
                
                <div class="results-container">
                    <div class="result-display">
                        <h3><i class="fas fa-square-root-alt"></i> Точный результат:</h3>
                        <div id="result" class="result-value">0</div>
                        <div class="result-note">С пробелами между разрядами, 10 знаков после запятой</div>
                    </div>
                    
                    <div class="result-display">
                        <h3><i class="fas fa-bullseye"></i> Округленный до целых:</h3>
                        <div id="rounded-result" class="rounded-value">0</div>
                        <div class="result-note">По выбранному методу округления</div>
                    </div>
                </div>
                
                <div id="error" class="error-message"></div>
            </div>

            <div class="examples">
                <h3><i class="fas fa-lightbulb"></i> Примеры для тестирования:</h3>
                <div class="example-buttons">
                    <button onclick="setExample('10, 2, 3, 4', 'add', 'multiply', 'add')">10 + (2 × 3) + 4</button>
                    <button onclick="setExample('100, 50, 2, 10', 'divide', 'subtract', 'multiply')">100 ÷ (50 - 2) × 10</button>
                    <button onclick="setExample('1, 0, 5, 2', 'add', 'divide', 'add')">1 + (0 ÷ 5) + 2</button>
                    <button onclick="setExample('999999999999, 0.5, 2, 0', 'multiply', 'add', 'add')">Граничные значения</button>
                    <button onclick="setExample('3.1415926535, 2.7182818284, 1.4142135623, 1.7320508075', 'add', 'multiply', 'subtract')">Много знаков</button>
                </div>
            </div>

            <div class="instructions">
                <h3><i class="fas fa-info-circle"></i> Особенности вычислений:</h3>
                <ul>
                    <li>Вычисления в скобках (Число2 операция Число3) выполняются первыми</li>
                    <li>Все промежуточные результаты округляются до 10 знаков после запятой</li>
                    <li>Диапазон: от -1 000 000 000 000.000000 до +1 000 000 000 000.000000</li>
                    <li>Промежуточные вычисления: до ±1 000 000 000 000.000000000</li>
                    <li>Округление до целых применяется только к финальному результату</li>
                </ul>
            </div>
        </main>

        <footer>
            <p>Финансовый калькулятор с приоритетами операций и разными видами округления</p>
        </footer>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    const numberInputs = ['num1', 'num2', 'num3', 'num4'];
    const operationSelects = ['op1', 'op2', 'op3'];
    const normalizedSpans = ['norm1', 'norm2', 'norm3', 'norm4'];
    
    const resultDiv = document.getElementById('result');
    const roundedResultDiv = document.getElementById('rounded-result');
    const errorDiv = document.getElementById('error');
    const calculateBtn = document.getElementById('calculate-btn');
    
    function validateInput(inputId) {
        const input = document.getElementById(inputId);
        const value = input.value;
        
        if (!value) {
            return true;
        }
        
        if (/[a-zA-Zа-яА-Я]/.test(value)) {
            return false;
        }
        
        if (value.includes('  ')) {
            return false;
        }
        
        if ((value.match(/-/g) || []).length > 1) {
            return false;
        }
        
        if (value.includes('-') && value[0] !== '-') {
            return false;
        }
        
        const temp = value.replace(/,/g, '.');
        if ((temp.match(/\./g) || []).length > 1) {
            return false;
        }
        
        return true;
    }
    
    function updateDisplay() {
        numberInputs.forEach((inputId, index) => {
            const input = document.getElementById(inputId);
            const span = document.getElementById(normalizedSpans[index]);
            const value = input.value;
            
            if (!validateInput(inputId)) {
                span.textContent = 'Ошибка';
                span.className = 'normalized-error';
            } else {
                const normValue = value ? value.replace(/,/g, '.').replace(/\s/g, '') : '0';
                span.textContent = normValue;
                span.className = 'normalized';
            }
        });
    }
    
    numberInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        input.addEventListener('input', updateDisplay);
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') calculate();
        });
    });
    
    calculateBtn.addEventListener('click', calculate);
    
    async function calculate() {
        for (const inputId of numberInputs) {
            if (!validateInput(inputId)) {
                errorDiv.textContent = 'Исправьте ошибки ввода чисел';
                resultDiv.textContent = 'Ошибка';
                roundedResultDiv.textContent = 'Ошибка';
                return;
            }
        }
        
        errorDiv.textContent = '';
        resultDiv.textContent = 'Вычисление...';
        roundedResultDiv.textContent = 'Вычисление...';
        
        const data = {};
        
        numberInputs.forEach((inputId, index) => {
            data[`num${index + 1}`] = document.getElementById(inputId).value;
        });
        
        operationSelects.forEach((selectId, index) => {
            const select = document.getElementById(selectId);
            data[`op${index + 1}`] = select.value;
        });
        
        const roundingMethod = document.querySelector('input[name="rounding"]:checked').value;
        data['rounding'] = roundingMethod;
        
        try {
            const response = await fetch('/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.error) {
                errorDiv.textContent = result.error;
                resultDiv.textContent = 'Ошибка';
                roundedResultDiv.textContent = 'Ошибка';
            } else {
                resultDiv.textContent = result.result;
                roundedResultDiv.textContent = result.rounded_result;
                
                if (result.normalized_numbers) {
                    result.normalized_numbers.forEach((norm, index) => {
                        const span = document.getElementById(normalizedSpans[index]);
                        span.textContent = norm;
                        span.className = 'normalized';
                    });
                }
                
                errorDiv.textContent = '';
            }
        } catch (error) {
            errorDiv.textContent = 'Ошибка соединения с сервером';
            resultDiv.textContent = 'Ошибка';
            roundedResultDiv.textContent = 'Ошибка';
        }
    }
    
    window.copyToClipboard = function(inputId) {
        const input = document.getElementById(inputId);
        input.select();
        input.setSelectionRange(0, 99999);
        try {
            navigator.clipboard.writeText(input.value);
            showToast('Скопировано!');
        } catch (err) {
        }
    };
    
    window.pasteFromClipboard = async function(inputId) {
        const input = document.getElementById(inputId);
        try {
            const text = await navigator.clipboard.readText();
            input.value = text;
            updateDisplay();
            showToast('Вставлено!');
        } catch (err) {
            input.focus();
            document.execCommand('paste');
            setTimeout(updateDisplay, 10);
        }
    };
    
    window.setExample = function(numbersStr, op1, op2, op3) {
        const numbers = numbersStr.split(', ');
        
        numbers.forEach((num, index) => {
            const input = document.getElementById(numberInputs[index]);
            input.value = num;
        });
        
        document.getElementById('op1').value = op1;
        document.getElementById('op2').value = op2;
        document.getElementById('op3').value = op3;
        
        updateDisplay();
        showToast('Пример загружен!');
    };
    
    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        toast.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #2ecc71; color: white; padding: 12px 20px; border-radius: 8px; z-index: 1000; animation: fadeInOut 3s ease-in-out;';
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.5s ease-out forwards';
            setTimeout(() => document.body.removeChild(toast), 500);
        }, 2500);
    }
    
    updateDisplay();
});
    </script>

    <style>
@keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(20px); }
    15% { opacity: 1; transform: translateY(0); }
    85% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(20px); }
}
@keyframes fadeOut {
    to { opacity: 0; }
}
    </style>
</body>
</html>